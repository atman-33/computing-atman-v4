## generate data-access-graphql

```bash
npx nx generate @nx/js:library data-access-graphql --directory=libs/web --importPath=@libs/web/data-access-graphql --tags=scope:web --bundler=swc

✔ Which unit test runner would you like to use? · none
✔ What should be the project name and where should it be generated? · web-data-access-graphql @ libs/web/data-access-graphql (This was derived from the folder structure. Please provide the exact name and directory in the future)
```

## install packages

```bash
npm i -D graphql-codegen @graphql-codegen/cli @graphql-codegen/near-operation-file-preset @graphql-codegen/typed-document-node @graphql-codegen/typescript-operations @graphql-codegen/typescript @graphql-codegen/typescript-graphql-request
```

> not install @parcel/watcher because installed with nx

```bash
npm i graphql-request
```

## create codegen.yml

`tools/graphql-codegen/codegen.yml`

```yml
overwrite: true
schema: 'dist/apps/api/autogenerated-schema.gql'

documents:
  - 'apps/**/*gql.ts'
  - 'libs/**/*gql.ts'

generates:
  libs/web/data-access-graphql/src/lib/types.ts:
    - typescript
  libs/:
    preset: near-operation-file
    presetConfig:
      extension: .gen.ts
      baseTypesPath: 'web/data-access-graphql/src/lib/types.ts'
    plugins:
      - typescript-operations
      - typescript-graphql-request
    config:
      gqlImport: 'graphql-request#gql'
      # not important for this example, but you can use this to additional flex
      pureMagicComment: true
      optimizeDocumentNode: true
      omitOperationSuffix: true
```

## add script to package.json

`package.json`

```json
"scripts": {
    ...,
    "----START----": "-------------------------",
    "start:gql:watch": "graphql-codegen --config tools/graphql-codegen/codegen.yml --watch"
```

## create data-access.gql.ts

> delete web-data-access-graphql.ts because not need.

`libs/web/data-access-graphql/src/lib/data-access.gql.ts`

ex.

```ts
import { gql } from 'graphql-request';

const GET_USERS = gql`
  query GetUsers {
    users {
      id
      email
      name
    }
  }
`;
```

## generate data-access.gql.gen.ts

- create `data-access.gql.ts`
- run script "gen:gql-client"

after that generated `data-access.gql.gen.ts` and `types.ts`

## create get-graphql-client.ts

`libs/web/data-access-graphql/src/lib/get-graphql-client.ts`

```ts
import { GraphQLClient } from 'graphql-request';
import { GraphQLClientRequestHeaders, MaybeLazy } from 'graphql-request/build/esm/types';
import { getSdk } from './data-access.gql.gen';

export const getGraphqlClient = (
  url: string,
  headers?: MaybeLazy<GraphQLClientRequestHeaders> | undefined
) => {
  const client = new GraphQLClient(url, {
    headers
  });

  return getSdk(client);
};
```

## update index.ts

`libs/web/data-access-graphql/src/index.ts`

```ts
export * from './lib/data-access.gql.gen';
export * from './lib/get-graphql-client';
```

## create graphql-client.ts in web

`apps/web/data-access/graphql-client.ts`

```ts
import { getGraphqlClient } from '@libs/web/data-access-graphql';

export const gql = getGraphqlClient('http://localhost:3000/graphql');
```

## use graphql-client

ex. `page.tsx`

```ts
import { gql } from '../data-access/graphql-client';

export default async function Page() {
  const { users } = await gql.GetUsers();
  console.log(users);

  return users.map((user) => (
  ...
```
