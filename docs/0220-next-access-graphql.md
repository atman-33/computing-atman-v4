## generate data-access-graphql

```bash
nx generate @nrwl/js:library --name=data-access-graphql --directory=web --tags "scope:web"

✔ Which unit test runner would you like to use? · none
✔ Which bundler would you like to use to build the library? Choose 'none' to skip build setup. · swc
```

## install packages

```bash
npm i -D graphql-codegen @graphql-codegen/cli @graphql-codegen/near-operation-file-preset @graphql-codegen/typed-document-node @graphql-codegen/typescript-operations @graphql-codegen/typescript @graphql-codegen/typescript-graphql-request @parcel/watcher
```

```bash
npm i graphql-request
```

## create codegen.yml

 `tools/graphql-codegen/codegen.yml`

```yml
overwrite: true
schema: 'dist/apps/api/autogenerated-schema.gql'

documents:
  - 'apps/**/*gql.ts'
  - 'libs/**/*gql.ts'

generates:
  libs/web/data-access-graphql/src/lib/types.ts:
    - typescript
  libs/:
    preset: near-operation-file
    presetConfig:
      extension: .gen.ts
      baseTypesPath: 'web/data-access-graphql/src/lib/types.ts'
    plugins:
      - typescript-operations
      - typescript-graphql-request
    config:
      gqlImport: 'graphql-request#gql'
      # not important for this example, but you can use this to additional flex
      pureMagicComment: true
      optimizeDocumentNode: true
      omitOperationSuffix: true
```

## add script to package.json

 `package.json`

```json
"scripts": {
    ...,
    "----START----": "-------------------------",
    "start:gql:watch": "graphql-codegen --config tools/graphql-codegen/codegen.yml --watch"
```

## create data-access.gql.ts

> delete web-data-access-graphql.ts because not need.

 `libs/web/data-access-graphql/src/lib/data-access.gql.ts`

```yml
overwrite: true
schema: 'dist/apps/api/autogenerated-schema.gql'

documents:
  - 'apps/**/*gql.ts'
  - 'libs/**/*gql.ts'

generates:
  libs/web/data-access-graphql/src/lib/types.ts:
    plugins:
      - typescript
  libs/:
    preset: near-operation-file
    presetConfig:
      extension: .gen.ts
      baseTypesPath: 'web/data-access-graphql/src/lib/types.ts'
    plugins:
      - typescript-operations
      - typescript-graphql-request
    config:
      gqlImport: 'graphql-request#gql'
      # not important for this example, but you can use this to additional flex
      pureMagicComment: true
      optimizeDocumentNode: true
      omitOperationSuffix: true
```

## generate data-access.gql.gen.ts

* create `data-access.gql.ts`  

 `libs/web/data-access-graphql/src/lib/data-access.gql.ts`

```ts
import { gql } from "graphql-request";

const GET_USERS = gql`
query GetUsers {
  users{
    id
    email
    name
  }
}
`;
```

* run script "gen:gql-client"

after that generated `data-access.gql.gen.ts`

## create get-graphql-client.ts

 `libs/web/data-access-graphql/src/lib/get-graphql-client.ts`

```ts
import { GraphQLClient } from 'graphql-request';
import { GraphQLClientRequestHeaders, MaybeLazy } from 'graphql-request/build/esm/types';
import { getSdk } from './data-access.gql.gen';

export const getGraphqlClient = (url: string, headers?: MaybeLazy<GraphQLClientRequestHeaders> | undefined) => {
    const client = new GraphQLClient(url, {
        headers
    });

    return getSdk(client);
};
```

## update index.ts

 `libs/web/data-access-graphql/src/index.ts`

```ts
export * from './lib/data-access.gql.gen';
export * from './lib/get-graphql-client';
```

## create graphql-client.ts in web

 `apps/web/data-access/graphql-client.ts`

```ts
import { getGraphqlClient } from '@okkino/web/data-access-graphql';

export const gql = getGraphqlClient("http://localhost:3000/graphql");
```

## use graphql-client  

ex. `page.tsx`

```ts
import { gql } from '../data-access/graphql-client';

export default async function Page() {
  const { users } = await gql.GetUsers();
  console.log(users);

  return users.map((user) => (
  ...
```
